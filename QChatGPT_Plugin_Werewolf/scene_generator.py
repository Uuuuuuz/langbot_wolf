import random
import aiohttp

# å¤©æ°”ç³»ç»Ÿ
WEATHER_CONDITIONS = {
    "æ™´æœ—": {
        "day": "é˜³å…‰æ˜åªšï¼Œå¤©ç©ºæ¹›è“ï¼Œå¶æœ‰ç™½äº‘é£˜è¿‡ã€‚",
        "night": "å¤œç©ºæ¸…æ¾ˆï¼Œç¹æ˜Ÿç‚¹ç‚¹ï¼Œåœ†æœˆé«˜æ‚¬ï¼Œæ´’ä¸‹çšæ´çš„é“¶è¾‰ã€‚"
    },
    "å¤šäº‘": {
        "day": "äº‘å±‚æ—¶åšæ—¶è–„ï¼Œå¤ªé˜³è‹¥éšè‹¥ç°ï¼Œåœ¨åœ°é¢æŠ•ä¸‹æ–‘é©³çš„å…‰å½±ã€‚",
        "night": "åšé‡çš„äº‘å±‚é®ä½äº†å¤©ç©ºï¼Œæ˜¾å¾—æ ¼å¤–æ˜æš—ï¼Œè®©äººå¿ƒç”Ÿä¸å®‰ã€‚"
    },
    "å°é›¨": {
        "day": "ç»†é›¨ç»µç»µï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€æ½®æ¹¿çš„æ°”æ¯ï¼Œé›¨ä¸åœ¨å¾®é£ä¸­è½»è½»é£˜è¡ã€‚",
        "night": "å¤œé›¨æ·…æ²¥ï¼Œé›¨æ»´æ•²æ‰“ç€çª—æˆ·ï¼Œå‘å‡ºè½»æŸ”çš„å£°å“ï¼Œè¿œå¤„å¶å°”ä¼ æ¥å‡ å£°è›™é¸£ã€‚"
    },
    "æš´é›¨": {
        "day": "å¤§é›¨å€¾ç›†ï¼Œé›·å£°è½°é¸£ï¼Œé—ªç”µåˆ’ç ´å¤©é™…ï¼Œç‹‚é£å‘¼å•¸è€Œè¿‡ã€‚",
        "night": "ç‹‚é£éª¤é›¨ï¼Œç”µé—ªé›·é¸£ï¼Œæš´é›¨å‡»æ‰“ç€å»ºç­‘å‘å‡ºéœ‡è€³æ¬²è‹çš„å£°å“ï¼Œé»‘æš—ä¸­æ—¶è€Œè¢«é—ªç”µç…§äº®ã€‚"
    },
    "é›¾": {
        "day": "æµ“é›¾å¼¥æ¼«ï¼Œèƒ½è§åº¦æä½ï¼Œå‘¨å›´çš„æ™¯ç‰©éƒ½ç¬¼ç½©åœ¨ä¸€ç‰‡æœ¦èƒ§ä¹‹ä¸­ã€‚",
        "night": "å¤œæ™šçš„æµ“é›¾æ›´æ˜¾è¯¡å¼‚ï¼Œé›¾æ°”åœ¨å¾®å¼±çš„å…‰çº¿ä¸‹æµåŠ¨ï¼Œä»¿ä½›éšè—ç€ä»€ä¹ˆã€‚"
    }
}

# ç©å®¶åå­—ç”Ÿæˆ
NAMES = [
    "æœˆå", "æ˜Ÿç’ƒ", "é›¨éœ–", "é›ªç‘¶", "é£é“ƒ", "äº‘è£³", "æ™“æ¢¦", "å¤œé˜‘", 
    "é˜³ç…¦", "é›·éŸ³", "éœœå", "é›¾è¯­", "å…‰è¾‰", "å½±å§¿", "æ¢¦å…°", "å¹»ç¿",
    "æ¸…éŸµ", "å¢¨å‡", "ç´«è±", "æ²æ™´", "æµè‹", "è‹¥æºª", "æ¾œé›…", "èŠ·è‹¥",
    "åƒå¯»", "æš®è‰²", "å‡Œæ³¢", "å¬é›¨", "é£é›ª", "æ˜ æœˆ", "ä¹¦å…°", "é—®é›"
]

def generate_player_name():
    """ç”Ÿæˆä¸€ä¸ªéšæœºçš„ä¼˜ç¾ç©å®¶åå­—"""
    return random.choice(NAMES)

async def get_game_status_summary(game_state: dict) -> str:
    """è·å–æ¸¸æˆçŠ¶æ€çš„è¯¦ç»†æ€»ç»“"""
    api_key = "hk-yp8t301000040760f637db2c86cdefc87b4e9c61cbbf803a"
    
    # æ„å»ºçŠ¶æ€ä¿¡æ¯
    status_info = {
        "åœºæ™¯ä¿¡æ¯": {
            "åç§°": game_state["name"],
            "å½“å‰å¤©æ°”": game_state["weather"],
            "æ—¶é—´": "ç™½å¤©" if game_state.get("is_day", False) else "å¤œæ™š",
            "åœºæ™¯å˜åŒ–": game_state.get("scene_changes", {}),  # è®°å½•åœºæ™¯ä¸­çš„ç‰©å“å˜åŒ–
            "åŒºåŸŸçŠ¶æ€": game_state.get("area_status", {})    # è®°å½•å„åŒºåŸŸçš„ç‰¹æ®ŠçŠ¶æ€
        },
        "ç©å®¶ä¿¡æ¯": {
            "å­˜æ´»ç©å®¶": game_state.get("alive_players", []),
            "æ­»äº¡ç©å®¶": game_state.get("dead_players", []),
            "ç©å®¶ä½ç½®": game_state.get("player_locations", {}),  # è®°å½•ç©å®¶æ‰€åœ¨åŒºåŸŸ
            "ç©å®¶çŠ¶æ€": game_state.get("player_status", {})     # è®°å½•ç©å®¶çš„ç‰¹æ®ŠçŠ¶æ€
        },
        "æ¸¸æˆè¿›ç¨‹": {
            "å½“å‰é˜¶æ®µ": game_state.get("game_phase", "æœªå¼€å§‹"),
            "æ˜¨å¤œäº‹ä»¶": game_state.get("last_night_events", []),
            "é‡è¦äº‹ä»¶": game_state.get("important_events", [])
        }
    }
    
    prompt = f"""ä½œä¸ºç‹¼äººæ€æ¸¸æˆçš„æ—ç™½ï¼Œè¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆä¸€æ®µç®€æ´ä½†å¯Œæœ‰æ°›å›´æ„Ÿçš„æ¸¸æˆçŠ¶æ€æè¿°ï¼š

{status_info}

è¦æ±‚ï¼š
1. é‡ç‚¹æè¿°åœºæ™¯å’Œç¯å¢ƒçš„å˜åŒ–ï¼ˆå¦‚æœæœ‰ï¼‰
2. æè¿°ç©å®¶ä»¬çš„çŠ¶æ€å’Œä½ç½®
3. æåŠé‡è¦äº‹ä»¶çš„å½±å“
4. è¥é€ ç´§å¼ çš„æ°›å›´
5. ä¸è¦æš´éœ²ä»»ä½•ç©å®¶èº«ä»½
6. ä½¿ç”¨ä¼˜ç¾ä½†ç®€æ´çš„è¯­è¨€

æ ¼å¼ï¼š
ã€ç¯å¢ƒæ¦‚å†µã€‘
- å¤©æ°”å’Œæ—¶é—´
- åœºæ™¯å˜åŒ–
- ç‰¹æ®ŠçŠ¶æ€

ã€äººç‰©åŠ¨å‘ã€‘
- ç©å®¶åˆ†å¸ƒ
- äººç‰©çŠ¶æ€

ã€é‡è¦äº‹ä»¶ã€‘
- å…³é”®äº‹ä»¶å›é¡¾ï¼ˆå¦‚æœæœ‰ï¼‰
"""

    try:
        async with aiohttp.ClientSession() as session:
            async with session.post(
                "https://api.openai-hk.com/v1/chat/completions",
                headers={"Authorization": f"Bearer {api_key}"},
                json={
                    "model": "claude-3-sonnet-20240229",
                    "messages": [{"role": "user", "content": prompt}],
                    "temperature": 0.7,
                    "max_tokens": 700
                }
            ) as response:
                result = await response.json()
                if "choices" in result and result["choices"]:
                    return result["choices"][0]["message"]["content"]
    except Exception as e:
        print(f"è·å–çŠ¶æ€æ€»ç»“å¤±è´¥ï¼š{str(e)}")
        return "è·å–æ¸¸æˆçŠ¶æ€å¤±è´¥..."

# åœºæ™¯èƒŒæ™¯æ•…äº‹
SCENE_STORIES = {
    "ç¥ç§˜æ‘åº„": "ä¸€ä¸ªä¸ä¸–éš”ç»çš„å¤è€æ‘åº„ï¼Œå› ä¸ºä¸€ä¸ªå¤è€çš„é¢„è¨€ï¼Œæ‘æ°‘ä»¬å¿…é¡»åœ¨æ¯ä¸ªæœˆåœ†ä¹‹å¤œè¿›è¡Œä¸€åœºå®¡åˆ¤ä»ªå¼ã€‚ç„¶è€Œï¼Œè¿™ä¸ªçœ‹ä¼¼å¹³é™çš„æ‘åº„å´æš—è—æ€æœº...",
    "å¤å ¡": "è¿™åº§å†å²æ‚ ä¹…çš„å¤å ¡ä¸¾åŠäº†ä¸€åœºç¥ç§˜çš„åŒ–å¦†èˆä¼šï¼Œå®¾å®¢ä»¬æˆ´ç€ç²¾ç¾çš„é¢å…·å°½æƒ…ç‹‚æ¬¢ã€‚ä½†éšç€åˆå¤œé’Ÿå£°çš„æ•²å“ï¼Œä¸€åœºè‡´å‘½çš„æ¸¸æˆæ‚„å¼€å§‹...",
    "è±ªåæ—…é¦†": "ä¸€åœºçªå¦‚å…¶æ¥çš„æš´é£é›ªè®©è¿™å®¶ååƒ»å±±åŒºçš„è±ªåæ—…é¦†ä¸å¤–ç•Œå¤±å»äº†è”ç³»ã€‚è¢«å›°çš„æ—…å®¢ä»¬å¾ˆå¿«å‘ç°ï¼Œä»–ä»¬ä¸­é—´æ½œä¼ç€ä¸€äº›å¯æ€•çš„ç§˜å¯†...",
    "åºŸå¼ƒå­¦æ ¡": "ä¼ è¯´è¿™æ‰€åºŸå¼ƒå¤šå¹´çš„å­¦æ ¡æ›¾å‘ç”Ÿè¿‡ä¸€ä»¶ç¦»å¥‡çš„å‘½æ¡ˆã€‚ä¸€ç¾¤æ¢é™©è€…åœ¨ä¸€ä¸ªé›¨å¤œé—¯å…¥æ ¡å›­ï¼Œå´æ„å¤–å·å…¥äº†ä¸€åœºç”Ÿæ­»æ¸¸æˆ...",
    "è±ªåé‚®è½®": "è¿™è‰˜è±ªåé‚®è½®æ­£åœ¨è¿›è¡Œå®ƒçš„å¤„å¥³èˆªï¼Œèˆ¹ä¸Šä¸¾åŠç€ç››å¤§çš„æ™šå®´ã€‚ç„¶è€Œå°±åœ¨æµ·ä¸Šç‹‚æ¬¢æ­£é…£æ—¶ï¼Œä¸€è¿è¯¡å¼‚çš„äº‹ä»¶å¼€å§‹å‘ç”Ÿ..."
}

SCENES = [
    {
        "name": "ç¥ç§˜æ‘åº„",
        "day_description": "é˜³å…‰ç…§å°„åœ¨æ‘åº„çš„æœ¨å±‹ä¸Šï¼Œæ‘æ°‘ä»¬ä¸‰ä¸‰ä¸¤ä¸¤åœ°åœ¨æ‘å£é—²èŠã€‚å¤è€çš„æ°´äº•è¾¹å›´ç€å‡ ä¸ªæ‰“æ°´çš„æ‘æ°‘ï¼Œè¿œå¤„çš„éº¦ç”°é‡‘é»„ä¸€ç‰‡ã€‚",
        "night_description": "æœˆé»‘é£é«˜çš„æ·±å¤œï¼Œæ‘åº„ç¬¼ç½©åœ¨æµ“é›¾ä¹‹ä¸­ã€‚å¤è€çš„æœ¨å±‹æ•£è½åœ¨æ‘å­å„å¤„ï¼Œæ˜é»„çš„ç¯å…‰é€è¿‡çª—æˆ·æ´’åœ¨æ³¥æ³çš„å°è·¯ä¸Šã€‚",
        "areas": {
            "æ‘å£å¹¿åœº": "æ‘å­çš„ä¸­å¿ƒå¹¿åœºï¼Œæœ‰ä¸€å£å¤è€çš„æ°´äº•å’Œå‡ å¼ çŸ³å‡³ã€‚å¤œæ™šæ—¶è¿™é‡Œé€šå¸¸å¾ˆå®‰é™ï¼Œèƒ½å¬åˆ°é£å¹è¿‡çš„å£°éŸ³ã€‚",
            "è°·ä»“": "ä¸€åº§ç ´æ—§çš„æœ¨åˆ¶è°·ä»“ï¼Œå †æ»¡äº†å¹²è‰å’Œå†œå…·ã€‚é»‘æš—ä¸­ä¼ æ¥è€é¼ çª¸çª¸çª£çª£çš„å£°éŸ³ã€‚",
            "æ•™å ‚": "æ‘å­é‡Œå”¯ä¸€çš„çŸ³å»ºç­‘ï¼Œå“¥ç‰¹å¼çš„å°–é¡¶åœ¨æœˆå…‰ä¸‹æ˜¾å¾—æ ¼å¤–é˜´æ£®ã€‚æ•™å ‚çš„é’Ÿå£°æ¯éš”ä¸€å°æ—¶éƒ½ä¼šå“èµ·ã€‚",
            "æ°‘å±…åŒº": "å‡ æ’æœ¨è´¨å¹³æˆ¿ï¼ŒçƒŸå›±é‡Œé£˜å‡ºç‚ŠçƒŸã€‚çª—æˆ·åæ—¶ä¸æ—¶èƒ½çœ‹åˆ°äººå½±æ™ƒåŠ¨ã€‚",
            "å°æ ‘æ—": "æ‘å­è¾¹ç¼˜çš„ä¸€ç‰‡æ ‘æ—ï¼Œæå¶èŒ‚å¯†ï¼Œæœˆå…‰éš¾ä»¥ç©¿é€ã€‚æ—¶å¸¸ä¼ æ¥çŒ«å¤´é¹°çš„å«å£°ã€‚"
        }
    },
    {
        "name": "å¤å ¡",
        "day_description": "é˜³å…‰é€è¿‡å½©ç»˜ç»ç’ƒçª—æŠ•å°„åœ¨å¤å ¡çš„å¤§ç†çŸ³åœ°æ¿ä¸Šï¼Œå½¢æˆæ–‘é©³çš„å…‰å½±ã€‚åŸå ¡çš„ä»†äººä»¬æ­£åœ¨æ‰“æ‰«å«ç”Ÿï¼Œåº­é™¢é‡Œä¼ æ¥é¸Ÿå„¿çš„é¸£å«å£°ã€‚",
        "night_description": "å¤œå¹•é™ä¸´ï¼Œå¤å ¡å†…çš„çƒ›å…‰æ‘‡æ›³ï¼Œåœ¨å¢™å£ä¸ŠæŠ•ä¸‹è¯¡å¼‚çš„å½±å­ã€‚èµ°å»Šä¸ŠæŒ‚ç€çš„ç›”ç”²åœ¨æœˆå…‰ä¸‹æ³›ç€å†·å…‰ï¼Œä»¿ä½›éšæ—¶ä¼šæ´»è¿‡æ¥ã€‚",
        "areas": {
            "å¤§å…": "åŸå ¡çš„ä¸­å¤®å¤§å…ï¼Œå¤©èŠ±æ¿å¾ˆé«˜ï¼ŒæŒ‚ç€å·¨å¤§çš„æå½¢åŠç¯ã€‚å¢™ä¸ŠæŒ‚ç€å†ä»£åŸä¸»çš„è‚–åƒç”»ï¼Œä»–ä»¬çš„ç›®å…‰ä¼¼ä¹åœ¨æ³¨è§†ç€æ¯ä¸ªäººã€‚",
            "å›¾ä¹¦å®¤": "å †æ»¡äº†å¤ç±çš„æˆ¿é—´ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€æ—§ä¹¦çš„æ°”å‘³ã€‚è§’è½é‡Œæœ‰ä¸€å¼ çº¢æœ¨ä¹¦æ¡Œå’Œä¸€æŠŠæ‘‡æ¤…ï¼Œä¹¦æ¶ä¸Šå¸ƒæ»¡èœ˜è››ç½‘ã€‚",
            "åœ°ä¸‹å®¤": "é˜´å†·æ½®æ¹¿çš„åœ°ä¸‹ç©ºé—´ï¼Œå¢™ä¸ŠæŒ‚ç€ç«æŠŠã€‚æœ‰å‡ ä¸ªæœ¨æ¡¶å’Œæ¶å­ï¼Œè§’è½é‡Œå †ç€ä¸€äº›ç¥ç§˜çš„ç®±å­ã€‚",
            "å¡”æ¥¼": "åŸå ¡æœ€é«˜å¤„çš„æˆ¿é—´ï¼Œèƒ½ä¿¯ç°æ•´ä¸ªå±±è°·ã€‚æœ‰ä¸€ä¸ªå¤©æ–‡æœ›è¿œé•œå’Œä¸€äº›å¥‡æ€ªçš„è§‚æµ‹ä»ªå™¨ã€‚",
            "åº­é™¢": "è¢«åŸå ¡ç¯ç»•çš„å†…é™¢ï¼Œç§ç€ä¸€äº›æ¯èçš„èŠ±è‰ã€‚ä¸­å¤®æœ‰ä¸€å£å¹²æ¶¸çš„å–·æ³‰ï¼Œå››å‘¨æ‘†ç€é•¿æ»¡é’è‹”çš„çŸ³æ¤…ã€‚"
        }
    },
    {
        "name": "è±ªåæ—…é¦†",
        "day_description": "é˜³å…‰é€è¿‡è½åœ°çª—ç…§è¿›æ—…é¦†å¤§å ‚ï¼Œæ°´æ™¶åŠç¯æŠ˜å°„å‡ºç’€ç’¨çš„å…‰èŠ’ã€‚äººä»¬åœ¨é¤å…äº«ç”¨æ—©é¤ï¼ŒæœåŠ¡å‘˜å¿™ç¢Œåœ°ç©¿æ¢­å…¶é—´ã€‚",
        "night_description": "å¤œæ·±äººé™ï¼Œæ—…é¦†çš„èµ°å»Šä¸Šåªå‰©ä¸‹åº”æ€¥ç¯çš„å¾®å…‰ã€‚åšé‡çš„åœ°æ¯¯å¸æ”¶äº†æ‰€æœ‰è„šæ­¥å£°ï¼Œå¶å°”èƒ½å¬åˆ°æˆ¿é—´é‡Œä¼ å‡ºçš„ç»†å¾®å“åŠ¨ã€‚",
        "areas": {
            "å¤§å ‚": "è£…ä¿®è±ªåçš„æ¥å¾…å¤§å…ï¼Œé“ºç€çº¢è‰²åœ°æ¯¯ã€‚å‰å°åé¢æŒ‚ç€ä¸€æ’æˆ¿é—´é’¥åŒ™ï¼Œå¢™ä¸Šçš„æ—¶é’Ÿæ»´ç­”ä½œå“ã€‚",
            "é¤å…": "å®½æ•çš„ç”¨é¤åŒºåŸŸï¼Œæ‘†æ”¾ç€åœ†å½¢é¤æ¡Œã€‚é¤å…·åå°„ç€æŸ”å’Œçš„ç¯å…‰ï¼Œç©ºæ°”ä¸­é£˜ç€é£Ÿç‰©çš„é¦™æ°”ã€‚",
            "ä¼‘æ¯å®¤": "èˆ’é€‚çš„ä¼šå®¢åŒºï¼Œæœ‰å‡ å¼ çš®è´¨æ²™å‘å’ŒèŒ¶å‡ ã€‚è§’è½é‡Œæ”¾ç€ä¸€æ¶è€å¼é’¢ç´ã€‚",
            "èµ°å»Š": "é“ºç€åšé‡åœ°æ¯¯çš„å®¢æˆ¿èµ°å»Šï¼Œä¸¤ä¾§æ˜¯ä¸€æ‰‡æ‰‡ç´§é—­çš„æˆ¿é—¨ã€‚å¢™ä¸Šçš„å£ç¯æŠ•ä¸‹æ˜é»„çš„å…‰ã€‚",
            "å¤©å°": "æ—…é¦†é¡¶å±‚çš„éœ²å°ï¼Œå¯ä»¥çœ‹åˆ°è¿œå¤„çš„åŸå¸‚å¤œæ™¯ã€‚å››å‘¨è£…ç€é“æ æ†ï¼Œåœ°ä¸Šæ‘†ç€å‡ å¼ èººæ¤…ã€‚"
        }
    },
    {
        "name": "åºŸå¼ƒå­¦æ ¡",
        "day_description": "é˜³å…‰é€è¿‡ç ´ç¢çš„çª—æˆ·ç…§è¿›ç©ºè¡è¡çš„æ•™å®¤ï¼Œç…§äº®äº†ç©ºä¸­é£˜æµ®çš„ç°å°˜ã€‚æ“åœºä¸Šé•¿æ»¡äº†æ‚è‰ï¼Œç§‹åƒåœ¨é£ä¸­è½»è½»æ‘‡æ™ƒã€‚",
        "night_description": "æœˆå…‰ç»™åºŸå¼ƒçš„æ ¡å›­è’™ä¸Šä¸€å±‚é“¶çº±ï¼Œç©ºæ—·çš„èµ°å»Šå›è¡ç€é£å£°ã€‚æ•™å®¤é‡Œçš„è¯¾æ¡Œæ¤…æŠ•ä¸‹é•¿é•¿çš„å½±å­ï¼Œé»‘æ¿ä¸Šä¾ç¨€å¯è§ç²‰ç¬”çš„ç—•è¿¹ã€‚",
        "areas": {
            "æ•™å®¤": "ä¸€é—´åºŸå¼ƒçš„æ•™å®¤ï¼Œè¯¾æ¡Œæ¤…ä¸œå€’è¥¿æ­ªã€‚é»‘æ¿ä¸Šè¿˜ç•™ç€æœªæ“¦é™¤çš„å­—è¿¹ï¼Œå¢™ä¸ŠæŒ‚ç€æ–‘é©³çš„æ•™å­¦å›¾ç‰‡ã€‚",
            "å›¾ä¹¦é¦†": "å¸ƒæ»¡ç°å°˜çš„å›¾ä¹¦é¦†ï¼Œä¹¦æ¶ä¸Šçš„ä¹¦ç±å·²ç»å‘é»„ã€‚ç ´æŸçš„æ¡Œæ¤…æ•£è½å„å¤„ï¼Œè§’è½é‡Œæœ‰å‡ å°è€æ—§çš„ç”µè„‘ã€‚",
            "ä½“è‚²é¦†": "ç©ºè¡è¡çš„ä½“è‚²é¦†ï¼Œæœ¨è´¨åœ°æ¿å·²ç»ç¿˜èµ·ã€‚å¢™ä¸ŠæŒ‚ç€è¤ªè‰²çš„æ ¡æ——ï¼Œçœ‹å°ä¸Šå †ç€ä¸€äº›ä½“è‚²å™¨æã€‚",
            "å®éªŒå®¤": "æ‚ä¹±çš„åŒ–å­¦å®éªŒå®¤ï¼Œè¯•ç®¡å’Œçƒ§æ¯å€’åœ¨å®éªŒå°ä¸Šã€‚è¯å“æŸœçš„ç»ç’ƒç¢è£‚ï¼Œç©ºæ°”ä¸­æœ‰è‚¡å¥‡æ€ªçš„å‘³é“ã€‚",
            "å¤©å°": "å­¦æ ¡æœ€é«˜å¤„çš„å¤©å°ï¼Œå›´æ å·²ç»ç”Ÿé”ˆã€‚åœ°ä¸Šæ•£è½ç€å‡ æŠŠæŠ˜å æ¤…ï¼Œå¯ä»¥çœ‹åˆ°æ•´ä¸ªæ ¡å›­çš„å…¨æ™¯ã€‚"
        }
    },
    {
        "name": "è±ªåé‚®è½®",
        "day_description": "é˜³å…‰æ´’åœ¨æ³¢å…‰ç²¼ç²¼çš„æµ·é¢ä¸Šï¼Œæµ·é¸¥åœ¨èˆ¹èˆ·é™„è¿‘ç›˜æ—‹ã€‚æ¸¸å®¢ä»¬åœ¨ç”²æ¿ä¸Šæ™’å¤ªé˜³ï¼Œäº«å—ç€æµ·é£çš„è½»æŠšã€‚è¿œå¤„å¶å°”èƒ½çœ‹åˆ°è·ƒå‡ºæ°´é¢çš„æµ·è±šã€‚",
        "night_description": "å¹•ç¬¼ç½©ç€æ— è¾¹çš„å¤§æµ·ï¼Œé‚®è½®çš„ç¯å…‰åœ¨æ¼†é»‘çš„æµ·é¢ä¸Šå€’æ˜ å‡ºé•¿é•¿çš„å…‰å¸¦ã€‚ç”²æ¿ä¸Šä¼ æ¥è½»æŸ”çš„éŸ³ä¹å£°ï¼Œæµ·é£ä¸­å¤¹æ‚ç€å’¸å’¸çš„æµ·æ°´æ°”æ¯ã€‚",
        "areas": {
            "è§‚æ™¯ç”²æ¿": "é‚®è½®æœ€ä¸Šå±‚çš„éœ²å¤©ç”²æ¿ï¼Œé“ºç€æŸšæœ¨åœ°æ¿ã€‚å››å‘¨æ˜¯é€æ˜çš„ç»ç’ƒæŠ¤å¢™ï¼Œæ‘†æ”¾ç€è®¸å¤šèººæ¤…ã€‚å¤œæ™šèƒ½çœ‹åˆ°æ»¡å¤©ç¹æ˜Ÿå€’æ˜ åœ¨æµ·é¢ä¸Šã€‚",
            "èˆä¼šå¤§å…": "é‡‘ç¢§è¾‰ç…Œçš„å¤§å‹èˆå…ï¼Œæ°´æ™¶åŠç¯é—ªçƒç€æŸ”å’Œçš„å…‰èŠ’ã€‚èˆæ± å‘¨å›´æ‘†æ”¾ç€åœ†å½¢é¤æ¡Œï¼Œèˆå°ä¸Šçš„ä¹å™¨å®‰é™åœ°ç­‰å¾…ç€æ¼”å¥è€…ã€‚",
            "èˆ¹é•¿å®¤": "ä½äºèˆ¹å¤´çš„æŒ‡æŒ¥ä¸­å¿ƒï¼Œå¢™ä¸ŠæŒ‚æ»¡äº†èˆªæµ·ä»ªå™¨å’Œæµ·å›¾ã€‚å®½å¤§çš„è½åœ°çª—èƒ½å°†æµ·é¢å°½æ”¶çœ¼åº•ï¼Œæ“æ§å°ä¸Šçš„ä»ªè¡¨å‘å‡ºå¾®å¼±çš„å…‰ã€‚",
            "è±ªåå¥—æˆ¿": "è£…ä¿®è€ƒç©¶çš„å®¢æˆ¿åŒºåŸŸï¼Œèµ°å»Šä¸¤ä¾§æ˜¯ä¸€æ‰‡æ‰‡é›•èŠ±æœ¨é—¨ã€‚åšé‡çš„åœ°æ¯¯å¸æ”¶äº†æ‰€æœ‰è„šæ­¥å£°ï¼Œå¢™ä¸Šçš„å£ç¯æ•£å‘ç€æ¸©æš–çš„å…‰ã€‚",
            "æœºæ¢°èˆ±": "ä½äºèˆ¹åº•çš„æœºæ¢°åŒºåŸŸï¼Œå……æ»¡äº†ç®¡é“å’Œä»ªè¡¨ã€‚å‘åŠ¨æœºçš„è½°é¸£å£°åœ¨è¿™é‡Œæ ¼å¤–æ¸…æ™°ï¼Œé—·çƒ­çš„ç©ºæ°”ä¸­å¼¥æ¼«ç€æœºæ²¹çš„æ°”å‘³ã€‚"
        }
    }
]

async def get_random_scene() -> dict:
    """è·å–éšæœºåœºæ™¯"""
    scene = random.choice(SCENES)
    weather = random.choice(list(WEATHER_CONDITIONS.keys()))
    weather_desc = WEATHER_CONDITIONS[weather]
    story = SCENE_STORIES[scene["name"]]
    
    # æ ¹æ®å¤©æ°”è°ƒæ•´æè¿°
    night_desc = f"{weather_desc['night']}\n{scene['night_description']}"
    
    # è¿”å›ç®€åŒ–çš„åœºæ™¯ä¿¡æ¯
    return {
        "name": scene["name"],
        "story": story,
        "weather": weather,
        "current_scene": night_desc,
        "areas": scene["areas"],
        # ä»¥ä¸‹å­—æ®µä»…ä¾›å†…éƒ¨ä½¿ç”¨
        "_full_data": {
            "day_description": f"{weather_desc['day']}\n{scene['day_description']}",
            "night_description": night_desc,
            "scene_changes": {},
            "area_status": {}
        }
    }

async def get_ai_behavior_report(ai_player: dict, game_state: dict, is_day: bool) -> str:
    """è·å–AIç©å®¶çš„è¡Œä¸ºæŠ¥å‘Š"""
    api_key = ""
    
    # æ„å»ºçŠ¶æ€ä¿¡æ¯
    player_info = {
        "ç©å®¶ä¿¡æ¯": {
            "åå­—": ai_player["name"],
            "èº«ä»½": ai_player["role"],  # AIå†…éƒ¨çŸ¥é“è‡ªå·±çš„èº«ä»½
            "çŠ¶æ€": ai_player.get("status", "æ­£å¸¸"),
            "å½“å‰ä½ç½®": ai_player.get("current_location", "æœªçŸ¥"),
            "å¯ç”¨åŒºåŸŸ": game_state["areas"]
        },
        "ç¯å¢ƒä¿¡æ¯": {
            "åœºæ™¯": game_state["name"],
            "å¤©æ°”": game_state["weather"],
            "æ—¶é—´": "ç™½å¤©" if is_day else "å¤œæ™š",
            "åœºæ™¯æè¿°": game_state["day_description"] if is_day else game_state["night_description"]
        },
        "æ¸¸æˆä¿¡æ¯": {
            "å­˜æ´»ç©å®¶": game_state.get("alive_players", []),
            "æ­»äº¡ç©å®¶": game_state.get("dead_players", []),
            "ä¸Šä¸€è½®äº‹ä»¶": game_state.get("last_events", [])
        }
    }
    
    prompt = f"""ä½œä¸ºä¸€ä¸ªç‹¼äººæ€æ¸¸æˆä¸­çš„ç©å®¶ï¼Œè¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯æè¿°ä½ çš„è¡Œä¸ºå’ŒçŠ¶æ€ï¼š

{player_info}

è¦æ±‚ï¼š
1. æè¿°ä½ å½“å‰çš„ä½ç½®å’Œè¡ŒåŠ¨
2. è¯´æ˜ä½ è§‚å¯Ÿåˆ°çš„æƒ…å†µ
3. æè¿°ä½ çš„å¿ƒç†çŠ¶æ€
4. ä¸è¦æš´éœ²ä½ çš„çœŸå®èº«ä»½
5. ç¬¦åˆä½ çš„æ€§æ ¼ç‰¹ç‚¹

è¯·ç”¨ä»¥ä¸‹å›ºå®šæ ¼å¼å›å¤ï¼š

ã€ä½ç½®ã€‘
æˆ‘ç°åœ¨åœ¨xxxï¼ˆå…·ä½“åŒºåŸŸåç§°ï¼‰

ã€è¡ŒåŠ¨ã€‘
- æ­£åœ¨åšä»€ä¹ˆ
- è§‚å¯Ÿåˆ°ä»€ä¹ˆ
- æœ‰ä»€ä¹ˆæƒ³æ³•

ã€çŠ¶æ€ã€‘
- èº«ä½“çŠ¶æ€
- å¿ƒç†çŠ¶æ€
- å¯¹å½“å‰å±€åŠ¿çš„çœ‹æ³•

ã€å¤‡æ³¨ã€‘
å…¶ä»–éœ€è¦è¡¥å……çš„ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
"""

    try:
        async with aiohttp.ClientSession() as session:
            async with session.post(
                "https://api.openai-hk.com/v1/chat/completions",
                headers={"Authorization": f"Bearer {api_key}"},
                json={
                    "model": "claude-3-sonnet-20240229",
                    "messages": [{"role": "user", "content": prompt}],
                    "temperature": 0.7,
                    "max_tokens": 350
                }
            ) as response:
                result = await response.json()
                if "choices" in result and result["choices"]:
                    return result["choices"][0]["message"]["content"]
    except Exception as e:
        print(f"è·å–AIè¡Œä¸ºæŠ¥å‘Šå¤±è´¥ï¼š{str(e)}")
        return f"{ai_player['name']}å½“å‰æ— æ³•è¡ŒåŠ¨..."

async def get_all_ai_reports(game_state: dict, is_day: bool) -> list:
    """è·å–æ‰€æœ‰AIç©å®¶çš„è¡Œä¸ºæŠ¥å‘Š"""
    reports = []
    ai_players = [p for p in game_state.get("alive_players", []) if p.get("is_ai", False)]
    
    for ai_player in ai_players:
        report = await get_ai_behavior_report(ai_player, game_state, is_day)
        reports.append({
            "name": ai_player["name"],
            "report": report
        })
        # æ›´æ–°ç©å®¶ä½ç½®å’ŒçŠ¶æ€
        if "ã€ä½ç½®ã€‘" in report:
            location = report.split("ã€ä½ç½®ã€‘")[1].split("\n")[1].strip()
            ai_player["current_location"] = location
    
    return reports

def format_game_start_message(scene: dict) -> str:
    """æ ¼å¼åŒ–æ¸¸æˆå¼€å§‹æ¶ˆæ¯"""
    message = [
        "ğŸ­ æ¸¸æˆåˆ›å»ºæˆåŠŸï¼",
        f"\nã€åœºæ™¯ã€‘{scene['name']}",
        f"\nã€èƒŒæ™¯ã€‘{scene['story']}",
        f"\nã€å¤©æ°”ã€‘{scene['weather']}",
        f"\nã€å½“å‰åœºæ™¯ã€‘\n{scene['current_scene']}",
        "\nã€æ¢ç´¢åŒºåŸŸã€‘"
    ]
    
    for area_name, area_desc in scene['areas'].items():
        message.append(f"\nâ€¢ {area_name}ï¼š{area_desc}")
    
    message.append("\n\nğŸ’« è¯·ä½¿ç”¨ !lrs join åŠ å…¥æ¸¸æˆ")
    
    return "".join(message)
